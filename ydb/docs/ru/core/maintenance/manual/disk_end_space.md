# Способы освобождения места на физических устройствах

При исчерпании места на дисках база данных может отвечать ошибками на все запросы. Для сохранения работоспособности рекомендуется удалить часть данных или расширить кластер блочными устройствами.

Ниже приведены инструкции которые могут помочь добавить или освободить место на дисках.

## Дефрагменировать вдиск

В ходе эксплуатации возникает внутренняя фрагментация вдиска. Узнать степень фрагментации можно на странице мониторинга вдиска. Дефрагментация дисков, фрагментированных на 20 и менее процентов не рекомендуется.

По модели отказа кластер переживает потерю двух вдисков одной группы без потери данных. Если в группе все вдиски работоспособны, нет вдисков в состоянии ошибки или репликации, удаление данных с одного из вдисков приведет к восстановлению вдиском данных в компактном виде. Следует понимать, что избыточность хранения данных будет снижена до завершения автоматической репликации данных.

В процессе репликации данных нагрузка на все вдиски группы будет увеличена, возможно ухудшение времени отклика.

1. Посмотреть коэффициент фрагментации на странице вдиска во вьювере (ссылка).

   Если значение превышает 20%, то дефрагментация позволит освободить место на диске.

2. Проверить состояние группы в которую входит вдиск. В группе не должно быть недосупных вдисков, вдисков в состоянии ошибки или репликации.

    Посмотреть состояние группые можно во вьювере (ссылка).

3. Выполнить команду wipe для вдиска.

    Все данные хранимые вдиском будут необратимо удалены, после чего вдиск начнет восстанавливать данные читая их с остальных вдисков группы.

    ```bash
    kikimr admin blobstorage group reconfigure wipe --domain <Номер домена> --node <ID узла> --pdisk <ID ПДиска> --vslot <Номер слота>
    ```

    Посмотреть нужную информацию для команды можно во вьювере (ссылка).

В случае заканчивающегося места на блочном устройстве, можно применить дефрагментацию на все устрйоство.

1. Проверить состояние групп в кластере. Не должно быть проблемных групп которые находятся на том же узле, что и проблемное устройство.

1. Зайти по ssh на узел где находится этот диск

1. Проверить, можно ли перезапустить процесс (ссылка на файл maintanence)

1. Остановить процесс

    ```bash
    sudo systemctl stop kikimr
    ```

1. Форматировать диск

    ```bash
    sudo kikimr admin blobstorage disk obliterate <путь до партлейбла устройства>
    ```

1. Запустить процесс

    ```bash
    sudo systemctl start kikimr
    ```

## Перевоз отдельных дисков с заполненных устройствах

Если дефрагментация не помогает освободить место на устройстве, то можно [перевозить](moving_vdisks.md#moving_disk) отдельные виртуальные диски.
