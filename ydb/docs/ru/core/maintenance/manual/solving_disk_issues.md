## Решение проблем неработоспособности кластера {#cluster_liveness_issues}

### Отказало не более 2 дисков входящих в группу хранения block-4-2{#storage_group_lost_two_disk}

При таком отказе потери данных не происходит, система сохраняет работоспособность, успешно выполняются запросы на чтение и запись. Возможно падение производительности вызванное переносом нагрузки обрабатываемой отказавшими дисками на оставшиеся в строю.

При одновременной недоступности 2 дисков по возможности рекомендуется восстановить работоспособность хотя бы одного из них, либо заменить один диск для начала процесса репликации. Это сохранит пространство для маневра в случае отказа третьего диска до завершения репликации.

### Отказало более 2 дисков входящих в группу хранения block-4-2{#exceeded_the_failure_modele}

Доступность и работоспособность системы может быть нарушена. Необходимо восстановить работоспособность хотя бы одного из дисков без потери хранившихся на нем данных.

## Проблемы с дисковой подсистемой {#storage_issues}

При исчерпании места на дисках база данных может отвечать ошибками на все запросы. Для сохранения работоспособности рекомендуется удалить часть данных или расширить кластер блочными устройствами.

Ниже приведены инструкции которые могут помочь добавить или освободить место на дисках.

### Дефрагменировать вдиск

В ходе эксплуатации возникает внутренняя фрагментация вдиска. Узнать степень фрагментации можно на странице мониторинга вдиска. Дефрагментация дисков, фрагментированных на 20 и менее процентов не рекомендуется.

По модели отказа кластер переживает потерю двух вдисков одной группы без потери данных. Если в группе все вдиски работоспособны, нет вдисков в состоянии ошибки или репликации, удаление данных с одного из вдисков приведет к восстановлению вдиском данных в компактном виде. Следует понимать, что избыточность хранения данных будет снижена до завершения автоматической репликации данных.

В процессе репликации данных нагрузка на все вдиски группы будет увеличена, возможно ухудшение времени отклика.

1. Посмотреть коэффициент фрагментации на странице вдиска во вьювере (ссылка).

   Если значение превышает 20%, то дефрагментация позволит освободить место на диске.

2. Проверить состояние группы в которую входит вдиск. В группе не должно быть недосупных вдисков, вдисков в состоянии ошибки или репликации.

    Посмотреть состояние группые можно во вьювере (ссылка).

3. Выполнить команду wipe для вдиска.

    Все данные хранимые вдиском будут необратимо удалены, после чего вдиск начнет восстанавливать данные читая их с остальных вдисков группы.

    ```bash
    kikimr admin blobstorage group reconfigure wipe --domain <Номер домена> --node <ID узла> --pdisk <ID ПДиска> --vslot <Номер слота>
    ```

    Посмотреть нужную информацию для команды можно во вьювере (ссылка).

В случае заканчивающегося места на блочном устройстве, можно применить дефрагментацию на все устрйоство.

1. Проверить состояние групп в кластере. Не должно быть проблемных групп которые находятся на том же узле, что и проблемное устройство.

1. Зайти по ssh на узел где находится этот диск

1. Проверить, можно ли перезапустить процесс (ссылка на файл maintanence)

1. Остановить процесс

    ```bash
    sudo systemctl stop kikimr
    ```

1. Форматировать диск

    ```bash
    sudo kikimr admin blobstorage disk obliterate <путь до партлейбла устройства>
    ```

1. Запустить процесс

    ```bash
    sudo systemctl start kikimr
    ```

### Разложить вдиски равномерно по устройствам

В случае, если вдиски расположены на блочных устройствах не равномерно, можно [перевезти их](#moving_vdisks) по одному с перегруженных устройств.

### Распределить нагрузку равномерно по группам

На странице web-мониторинга хайва, в нижней части экрана есть кнокп "Reassign Groups".
При нажатии на нее появится окно с параметрамми для балансировки:

* **Storage pool** - пулл групп хранения для балансировки
* **Storage group** - в случае если не указан предыдущий пункт, можно указать отдельно только одну группу
* **Type** - тип таблеток для которых будет производиться балансировка
* **Channels** - диапазон каналов, для которых будет производиться балансировка
* **Percent** - процент от общего количества каналов таблеток которые переедут в результате балансировки
* **Inflight** - количество одновременно переезжающих на другие группы таблеток

После указания всех параметров, следует нажать сначала "Query", который покажет количество каналов попавшие под переезде и разблокирует кнопку "Reassign".
При нажатии которой начнется балансировка.

