## BEGIN, COMMIT, ROLLBACK (работа с транзакциями){#transactions}

`BEGIN`, `COMMIT`, и `ROLLBACK` – это команды, которые используются для управления транзакциями. Транзакции – это способ группировки одной или нескольких операций с базой данных в единую единицу работы. Транзакция может состоять из одной или нескольких SQL-операций и использоваться для обеспечения согласованности данных. Транзакция обеспечивает гарантированное выполнение всех или ни одной SQL-операции в своих рамках. 

Помимо транзакции, существуют ещё сессии. Сессия — это одно соединение с базой данных, которое начинается при подключении к базе данных и завершается при её отключении. Именно в рамках сессии выполняется транзакция, которая начинается с команды `BEGIN` и завершается командой `COMMIT` (успешное завершение) или `ROLLBACK` (откат). В случае если сессия неожиданно прерывается, тогда все транзакции, которые были начаты в текущей сесcии – автоматически откатываются.

Рассмотрим каждую из команд:
* `BEGIN` – инициирует новую транзакцию. После выполнения этой команды все последующие операции с базой данных будут выполняться в рамках этой транзакции.
* `COMMIT` – завершает транзакцию, применяя все её операции. Если все операции в транзакции были успешными, результаты этих операций фиксируются (становятся постоянными). Изменения становятся видны последующим транзакциям.
* `ROLLBACK` – откатывает транзакцию, отменяя все её операции, если в процессе выполнения транзакции возникли ошибки или отмена транзакции производится приложением исходя из внутренней логики работы. Когда вызывается `ROLLBACK`, только изменения, сделанные в рамках текущей транзакции отменяются. Изменения, сделанные другими транзакциями (даже если они были запущены и завершены во время выполнения текущей транзакции), остаются нетронутыми. В случае если в процессе выполнения транзакции произошла ошибка, то дальнейшая работа с такой транзакцией становится невозможна – нужно делать `ROLLBACK`, так как выполнение `COMMIT` вернет ошибку. Если произойдет разрыв сессии во время активной транзакции – автоматически будет выполнен `ROLLBACK`. Более подробную информацию про управление конкурентным доступом (mvcc) можно найти в [этой статье](https://ydb.tech/en/docs/concepts/mvcc).

Предположим, нужно внести изменения в разные строчки таблицы для разных столбцов так, чтобы транзакция была объединена в одну рабочую единицу и имела гарантии ACID. Такая запись может выглядеть так:
```sql
--Начало транзакции
BEGIN;

-- Инструкция обновления данных 
UPDATE movies
SET length = INTERVAL '02:15:00'
WHERE title = 'Star Wars: Episode I - The Phantom Menace';

-- Инструкция обновления данных 
UPDATE movies
SET star = 'Tom Hanks'
WHERE title = 'Indiana Jones and the Last Crusade';
```
Если все данные верны – нужно выполнить инструкцию подтверждения транзакции:
```sql
COMMIT;
```