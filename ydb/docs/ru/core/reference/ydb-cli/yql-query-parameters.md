# Передача параметров в команды исполнения YQL-запросов

Команды исполнения YQL-запросов [`yql`](yql.md), [`scripting yql`](scripting-yql.md) и [`table query execute`](table-query-execute.md) поддерживают одинаковый синтаксис и возможности передачи параметров, описанные в данной статье.

Для работы с параметрами в YQL-запросе должны присутствовать их определения [командой YQL `DECLARE`](../../yql/reference/syntax/declare.md).

Значения параметров могут быть заданы в командной строке, загружены из файлов в формате [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %}, а также считаны с `stdin` в бинарном формате или в формате [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %}. При передаче параметров через `stdin` поддерживается многократное поточное исполнение YQL-запроса с разными значениями параметров, с возможностью пакетирования.

Для управления передачей параметров поддерживаются следующие опции:

Имя | Описание
---|---
`-p, --param STR` | Значение параметра в формате `$name=value`, где `$name` -- имя параметра, а `value` - значение, являющееся корректным value для формата [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% else %}(https://en.wikipedia.org/wiki/JSON){% endif %}. Опция может быть указана несколько раз для разных параметров.<br><br>Все указываемые параметры должны быть декларированы в YQL-запросе [оператором `DECLARE`](../../yql/reference/syntax/declare.md). Если заданный опцией параметр не декларирован, будет выдана ошибка "Query does not contain parameter".<br><br>Если значения одного и того же параметра заданы несколько раз, будет выдана ошибка "Parameter value found in more than one source".<br><br>Обратите внимание, что символ `$` является специальным во многих операционных системах, поэтому для его корректной передачи он должен либо быть экранирован, либо использована фиксированная строковая константа (в Linux обрамленная символами одиночной кавычки `'`).
`--param-file PATH` | Имя файла в формате [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %} в кодировке [UTF-8]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/UTF-8){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/UTF-8){% endif %}, в котором задаются значения параметров, сопоставляемые с параметрами YQL-запроса по именам ключей.<br><br>Имена ключей в json-файле указываются без начального символа `$`. В файле могут присутствовать не только ключи для задекларированных в YQL-запросе параметров, но также и произвольные дополнительные ключи, значения которых будут проигнорированы без выдачи сообщений об ошибке.<br><br>Опция может быть задана несколько раз. Если значения задекларированного в YQL-запросе параметра будут обнаружены одновременно в нескольких файлах, или заданы в командной строке опцией `--param`, будет выдана ошибка "Parameter value found in more than one source".
`STDIN` | YDB CLI автоматически определяет что `stdin` не связан с терминалом ввода, без указания каких-либо специальных опций.<br><br>Использование `stdin` позволяет передавать на вход содержимое файлов операторами `>`/`<`, или перенаправлять вывод другой команды оператором `\|`. По-умолчанию переданный контент интерпретируется так же, как и файл в опции `--param-file` (документ JSON). При этом, передача контента через `stdin` позволяет воспользоваться дополнительными возможностями при использовани опций `--stdin-format`, `--stdin-par`, и `--batch`, описанных ниже.
`--input-format STR` | Базовый формат представления значений параметров, действующий на все способы их передачи (командная строка, файл, `stdin`).<br><br>Возможные значения:<ul><li>`json-unicode` (по-умолчанию) — [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %}</li><li>`json-base64` — [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %}, в котором значения параметров с типом "бинарная строка" (`DECLARE $par AS String`) представлены в кодировке [Base64]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/Base64){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/Base64){% endif %}. Такая возможность позволяет передавать любые бинарные данные, декодирование которых из Base64 выполнит YDB CLI.</li></ul>
`--stdin-format STR` | Формат представления параметров на `stdin`.<br><br>Возможные значения:<ul><li>`json-unicode` — [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %}</li><li>`json-base64` — [JSON]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/JSON){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/JSON){% endif %}, в котором значения параметров с типом "бинарная строка" (`DECLARE $par AS String`) представлены в кодировке [Base64]{% if lang == "ru" %}(https://ru.wikipedia.org/wiki/Base64){% endif %}{% if lang == "en" %}(https://en.wikipedia.org/wiki/Base64){% endif %}. Такая возможность позволяет передавать любые бинарные данные, декодирование которых из Base64 выполнит YDB CLI.</li><li>`raw` - бинарные данные, представлящие значение параметра, имя которого задается опцией `--stdin-par`.</li></ul>Если формат представления параметров на `stdin` не задан, то применяется формат, заданный общей опцией `--input-format`.
`--stdin-format STR` | Определение правил разделения наборов параметров (фрейминга) для `stdin`.<br><br>Возможные значения:<ul><li>`no-framing` (по умолчанию) - `stdin` не используется, либо на `stdin` ожидается один набор параметров, с однократным исполнением YQL-запроса после завершения чтения `stdin`.</li><li>`newline-delimited` - символ перевода строки отмечает на `stdin` окончание одного набора параметров, отделяя его от следующего. Момент отправки YQL-запроса на сервер определяется опцией `--batch`.</li></ul>
`--stdin-par STR` | Задает имя параметра для `stdin`, позволяя передавать на него только значения без имен параметров.<br><br> Указывается без символа `$`. Опция обязательна при использовании `raw` формата. При использовании с JSON-форматами ожидает на входе только значение в корректном для JSON представлении. При включенном фрейминге опция может быть задана несколько раз с разными именами параметров, в этом случае подстановка будет осуществляться с чередованием имен параметров.
`--batch STR` | Режим пакетирования значений наборов параметров, получаемых через `stdin`.<br><br>Возможные значения:<ul><li>`iterative` (по умолчанию) - <b>Пакетирование выключено.</b> YQL-запрос исполняется для каждого полученного набора параметров, то есть ровно один раз при выключенном фрейминге или отсутствии активного `stdin`. При включенном фрейминге очередной YQL-запрос уходит на исполнение по факту получения на `stdin` разделителя наборов параметров, а исполнение команды завершается при закрытии потока на `stdin`.</li><li>`full` - <b>Полный пакет.</b> YQL-запрос исполняется один раз после закрытия потока на `stdin`, все полученные наборы параметров заворачиваются в `List<>`, имя параметра задается опцией `--stdin-par`.</li><li>`adaptive` - <b>Адаптивное пакетирование.</b> YQL-запрос исполняется каждый раз, когда срабатывает ограничение на количество наборов параметров в одном запросе (`--batch-limit`) или на задержку обработки (`--batch-max-delay`). Все полученные к этому моменту наборы параметров заворачиваются в `List<>`, имя параметра задается опцией `--stdin-par`.
`--batch-limit NUM` | Максимальное количество наборов параметров в пакете для адаптивного режима пакетирования.<br><br>Следующий пакет будет отправлен на исполнение YQL-запросом, если количество наборов данных в нем достигло указанного значения. Значение по умолчанию `1000`. Установка в `0` снимает ограничение.<br><br>Необходимо учитывать, что параметры передаются в YQL без стриминга, и общий объем одного GRPC-запроса, в который включаются значения параметров, имеет верхнюю границу около 5 мегабайт.
`--batch-max-delay VAL` | Максимальная задержка отправки на обработку полученного набора параметров для адаптивного режима пакетирования.<br><br>Задается в виде числа с размерностью времени - `s`, `ms`, `m`. По умолчанию `1s` (1 секунда). YDB CLI будет отсчитывать время с момента получения первого набора параметров для пакета, и отправит накопившийся пакет на исполнение как только время превысит значение, указанное в данной опции. Опция позволяет получить эффективное пакетирование в случае непредсказуемого темпа появления новых наборов параметров на `stdin`.

## Примеры {#examples}

{% include [ydb-cli-profile](../../_includes/ydb-cli-profile.md) %}

Примеры написаны для команды `table query execute`, но при этом работоспособны и для любой другой команды исполнения YQL-скрипта.

### Простейший параметризованный запрос {#example-simple}

Значение в командной строке:

```bash
{{ ydb-cli }} -p db1 table query execute -q 'declare $a as Int64;select $a' --param '$a=10'
```

Передача в виде JSON через stdin:

```bash
echo '{"a":10}' | {{ ydb-cli }} -p db1 table query execute -q 'declare $a as Int64;select $a'
```

Чтение из JSON файла:

```bash
echo '{"a":10}' > p1.json
{{ ydb-cli }} -p db1 table query execute -q 'declare $a as Int64;select $a' --param-file p1.json
```

### Передача параметров разных типов из множества источников {#example-multisource}

```bash
echo '{ "a":10, "b":"Some text", "x":"Ignore me" }' > p1.json
echo '{ "c":"2012-04-23T18:25:43.511Z" }' | {{ ydb-cli }} -p db1 table query execute \
  -q 'declare $a as Int64;declare $b as Utf8;declare $c as DateTime;declare $d as Int64;
      select $a, $b, $c, $d' \
  --param-file p1.json \
  --param '$d=30'
```

### Передача бинарных строк в кодировке Base64 {#example-base64} 

```bash
{{ ydb-cli }} -p db1 table query execute \
  -q 'declare $a as String;select $a' \
  --input-format json-base64 \
  --param '$a="SGVsbG8sIHdvcmxkCg=="' 
```

### Передача бинарного контента в поле типа "бинарная строка" {#example-raw}

```bash
curl -L http://ydb.tech/docs | {{ ydb-cli }} -p db1 table query execute \
  -q 'declare $a as String;select LEN($a)' \
  --stdin-format raw \
  --stdin-par a
```

### Итеративная обработка нескольких наборов параметров {#example-iterate}

```bash
echo -e '{"a":10,"b":20}\n{"a":15,"b":25}\n{"a":35,"b":48}' > p1.json
cat p1.json | {{ ydb-cli }} -p db1 table query execute \
  -q 'declare $a as Int64;declare $b as Int64;select $a+$b' \
  --stdin-format newline-delimited
```

### Полная пакетная обработка {#example-full}

В данном примере использована вариант передачи именованных параметров в список структур, применимый для полного и адаптивного режимов пакетирования.

```bash
echo -e '{"a":10,"b":20}\n{"a":15,"b":25}\n{"a":35,"b":48}' | \
{{ ydb-cli }} -p db1 table query execute \
  -q 'declare $x as List<Struct<a:Int64,b:Int64>>;select ListLength($x), $x' \
  --stdin-format newline-delimited \
  --stdin-par x \
  --batch full
```

### Адаптивная пакетная обработка {#example-adaptive}

#### Триггер по задержке обработки

Для демонстрации работы адаптивного пакетирования со срабатыванием триггера по задержке обработки в первой строке команды ниже производится генерация 1000 строк с задержкой в 0.2 секунды. Команда будет отображать пакеты параметров в каждом следующем вызове YQL-запроса.

В данном примере использован вариант передачи параметров без имени в типизированный список, применимый для полного и адаптивного режимов пакетирования.

```bash
for i in $(seq 1 1000);do echo "Line$i";sleep 0.2;done | \
{{ ydb-cli }} -p db1 table query execute \
  -q 'declare $x as List<Utf8>;select ListLength($x), $x' \
  --stdin-format newline-delimited \
  --stdin-format raw \
  --stdin-par x \
  --batch adaptive
```

Значение `--batch-max-delay` по умолчанию установлено в 1 секунду, поэтому в каждый запрос будет попадать около 5 строк. При этом в первый пакет пойдут все строки, накопившиеся за время открытия соединения с БД, и он будет больше чем последующие.

#### Триггер по количеству записей

Для демонстрации работы адаптивного пакетирования со срабатыванием триггера по количеству наборов параметров в первой строке команды ниже производится генерация 200 строк. Команда будет отображать пакеты параметров в каждом следующем вызове YQL-запроса, учитывая заданное ограничение `--batch-limit` равное 20 (по умолчанию 1000).

В данном примере также показана возможность объединения параметров из разных источников, и формирование json на выходе.

```bash
for i in $(seq 1 200);do echo "Line$i";done | \
{{ ydb-cli }} -p db1 table query execute \
  -q 'declare $x as List<Utf8>;declare $p2 as Int64;
      select ListLength($x) as count, $p2 as p2, $x as items' \
  --stdin-format newline-delimited \
  --stdin-format raw \
  --stdin-par x \
  --batch adaptive \
  --batch-limit 20 \
  --param '$p2=10' \
  --format json-unicode
```

### Конвейерная обработка сообщений, считываемых из топика {#example-adaptive-pipeline-from-topic}

Примеры передачи потока считываемых из топика сообщений в качестве параметров для исполнения YQL-запросов приведены в [этой статье](topic-pipeline.md#example-read-to-yql-param), среди других примеров работы с топиками.